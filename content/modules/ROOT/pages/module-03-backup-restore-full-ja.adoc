= 仮想マシンの保護

== 1. はじめに

_この演習では、OpenShift 上で稼働する仮想マシンを保護するための Kasten ポリシーを作成・実行し、ローカルおよびリモートのバックアップソースからのリストアをテストします。_

== 2. 仮想マシンの作成

まず、この演習で使用する新しい VM を新しいプロジェクトに作成します。

. *_OpenShift コンソール_* で、*_Virtualization_* → *_Virtual Machines_* に移動します。
. 作業用の新しいプロジェクトを作成するには、*_Project_* メニューを選択し、*_Create Project_* をクリックします。
+
image::module-03-backup-restore/01.png[]

. *_Name_* に `kasten-lab-{user}` と入力し、*_Create_* をクリックします。
. サイドバーで *_Virtualization → Virtual Machines_* を選択し、`kasten-lab-{user}` プロジェクト内で *_Create VirtualMachine → From template_* をクリックします。
+
image::module-03-backup-restore/03.png[]
+
====
[CAUTION]
Kasten は `InstanceType` を使用してプロビジョニングされた VM を保護できますが、現在はリストア時に手動変換が必要です。この作業はこのラボの範囲外です。
今後のリリースで `InstanceType` の完全サポートが追加される予定です。
====

. *_Template catalog_* から `fedora-server-small` テンプレートを選択します。
+
image::module-03-backup-restore/04.png[]

. *_VirtualMachine name_* を `fedora-k10` に変更し、*_Quick create VirtualMachine_* をクリックします。
+
image::module-03-backup-restore/05.png[]
+
====
[NOTE]
これにより、`{kasten_storageclass}` StorageClass 用に推奨されるストレージ設定で VM がプロビジョニングされます。
具体的には *_Block VolumeMode_* が設定され、OpenShift ノード間でのライブマイグレーションに必要な *_ReadWriteMany_* アクセスが有効になります。
====

. サイドバーから *_Storage → PersistentVolumeClaims_* に移動し、`fedora-k10-volume` PersistentVolumeClaim の設定を確認します。
+
image::module-03-backup-restore/06.png[]

== 3. Block モードエクスポートの有効化

====
[NOTE]
一部のストレージプロビジョナーでは Block VolumeMode が完全にサポートされない場合があります。
まず StorageClass が互換性を持つかどうかを https://docs.kasten.io/latest/operating/k10tools.html#k10-primer-block-mount-check[primer スクリプト] で確認してください。
このラボでは、`openshift-storage.rbd.csi.ceph.com` プロビジョナーが互換性を持つことが分かっているため、この確認は省略します。
====

. あなたの `StorageClass` はすでに、`{kasten_storageclass}` StorageClass を使用して Kasten Data Mover が生のブロックボリュームをエクスポートできるよう設定されています。
+
*_Web Terminal_* で次のコマンドを実行し、`k10.kasten.io` で始まるアノテーションが存在することを確認します。
+
[source,bash,role=execute,subs="attributes"]
----
oc get sc {kasten_storageclass} -ojsonpath=='{.metadata.annotations}';echo
----
+
====
[TIP]
アノテーションを付与するコマンドは以下です（実行する必要はありません）:

[source,bash]
----
oc annotate storageclass {kasten_storageclass} \
  k10.kasten.io/sc-supports-block-mode-exports=true
----
====

. Kasten はデフォルトで ODF の Ceph Volume Manager と直接 API 連携し、ブロックデータの転送を行います。
これには VM 保護時のストレージ消費量を削減できる増分バックアップのサポートも含まれます。
+
====
[IMPORTANT]
多くの Kubernetes バックアップソリューションは `volumeMode: Block` PVC のローカル CSI スナップショットをオーケストレーションできますが、_スナップショットはバックアップではありません_。
`volumeMode: Block` PVC のオフクラスタデータ転送ができるバックアップソリューションが重要です。
Velero や OADP ではこの機能は現在サポートされていません。
====

== 4. Kasten ポリシーの作成

. *_Kasten Dashboard_* で *_Applications_* を選択し、検出されたすべての namespace を表示します。
+
image::module-03-backup-restore/07.png[]
+
`kasten-lab-{user}` アプリケーションが *_Unmanaged_* と表示されているはずです。
これはまだポリシーで保護されていないことを意味します。
+
====
[TIP]
`openshift` で始まる namespace がアプリケーション一覧に表示されることがありますが、これらは OpenShift システム自身のアプリが稼働する namespace です。
通常は一般ユーザには見せないようにすることが多いです。
これは、K10 Operand の `spec` に `excludedApps` リストを追加することで除外できます。
image::module-03-backup-restore/08.png[]
以下のコマンドで `openshift` で始まる namespace の一覧を取得し、K10 Operand の YAML に貼り付けることができます。
[source,bash,role=execute,subs="attributes"]
----
oc get ns --no-headers=true | \
  awk 'BEGIN { print "  excludedApps:" } /^openshift/{print "  -",$1}'
----
====

. *_Applications_* の一覧で `kasten-lab-{user}` をクリックし、検出されたワークロードとリソースの詳細を表示します。
+
image::module-03-backup-restore/09.png[]

. *_Application Details_* ウィンドウを閉じます。
. `kasten-lab-{user}` の右側で *_... → Create a Policy_* を選択します。
+
image::module-03-backup-restore/10.png[]

. *_Name_* と *_Action_* はデフォルトのままにします。
+
image::module-03-backup-restore/11.png[]
+
====
[NOTE]
ポリシープリセットを使用すると、管理者が SLA ベースの構成を事前定義し、他のユーザーによるセルフサービスでのデータ保護を簡素化できます。
====

. *_Hourly Backup Frequency_* と *_Snapshot Retention_* もデフォルトのままにします。
+
image::module-03-backup-restore/12.png[]
+
====
[NOTE]
*_Advanced Frequency Options_* では、スナップショットの実行時刻や回数、日次/週次/年次への昇格ルールを細かく設定できます。
*_Backup Window_* ではポリシーの実行可能時間帯を指定できます。
*_Use Staggering_* を有効にすると負荷分散が可能です。
このラボではこれらは設定しません。
====

. *_Enable Backups via Snapshot Exports_* を有効にし、*_Export Location Profile_* に `kastenbackups-{user}` を選択します。
+
image::module-03-backup-restore/13.png[]
+
====
[NOTE]
デフォルトではスナップショット全体がエクスポートされますが、場合によってはスナップショットのメタデータのみをエクスポートすることも可能です。
これは特定のシナリオでパフォーマンスを大幅に向上させます。
====

. *_Select Applications_* で `kasten-lab-{user}` namespace が選択されていることを確認します。
+
image::module-03-backup-restore/14.png[]
+
====
[NOTE]
通常は namespace 単位でポリシー対象を決めますが、Kasten は Kubernetes ラベルによる選択も可能です。
これにより将来追加される VM を自動的に保護する設定も可能です。
また API Group やリソースタイプによる除外もできます。
====

. 残りの設定はデフォルトのままにします。
+
====
[TIP]
Kasten UI の多くの操作では *_</> YAML_* ボタンで Kubernetes ネイティブの YAML を表示できます。
====

. *_Create Policy_* をクリックします。

== 5. ゲストファイルシステムのフリーズ

Kasten はスナップショットの前後にゲスト OS のファイルシステムをフリーズ/アンフリーズできます。  
VM に `k10.kasten.io/freezeVM=true` アノテーションを付けることで有効になります。

. *_Web Terminal_* で以下を実行します。
+
[source,bash,role=execute,subs="attributes"]
----
oc annotate virtualmachine fedora-k10 \
  -n kasten-lab-{user} \
  k10.kasten.io/freezeVM=true
----
+
====
[NOTE]
フリーズ/アンフリーズは VM が *_Running_* 状態のときのみ実行されます。
====
+
====
[WARNING]
デフォルトでは 5 分でスナップショットが完了しない場合は中断して VM をアンフリーズします。
`kubeVirtVMs.snapshot.unfreezeTimeout` で変更可能です。
====

== 6. ポリシーの実行

ポリシーは UI またはプログラムから手動で実行可能です。

. *_Kasten Dashboard → Policies → Policies_* で `kasten-lab-backup-{user}` の *_Run Once_* をクリックします。
+
image::module-03-backup-restore/15.png[]

. 有効期限を指定する場合は設定し、*_Yes, Continue_* をクリックします。
+
image::module-03-backup-restore/16.png[]

. サイドバーから *_Dashboard_* を選択します。
. *_Actions_* で `kasten-lab-backup-{user}` の実行状況を確認します。
+
image::module-03-backup-restore/17.png[]
+
各 *_Action_* をクリックすると YAML や保護されたボリューム情報が見られます。
+
image::module-03-backup-restore/18.png[]

. バックアップ完了まで待ちます（約5分以内）。
+
====
[WARNING]
失敗した場合はエラーメッセージを確認してください。

image::module-03-backup-restore/18b.png[]
====

== 7. ローカルリストアの実行

同一クラスタ内でのリストアではローカル RestorePoint を選択するのが最速です。

. *_Kasten Dashboard_* の *_Applications_* を開きます。
+
`kasten-lab-{user}` の *_Status_* が *_Compliant_* に変わっているはずです。

. `kasten-lab-{user}` の右側で *_... → Restore_* を選択します。
+
image::module-03-backup-restore/19.png[]

. 最新の RestorePoint を選び、ローカル版をクリックします。
+
image::module-03-backup-restore/20.png[]

. デフォルト設定のまま *_Restore_* をクリックします。
+
image::module-03-backup-restore/21.png[]
+
====
[WARNING]
Kasten は実行中の VM を終了し、既存リソースを上書きします。
ただし RestorePoint にないリソースは削除されません。
====

. 確認画面で *_Restore_* をクリックします。
+
image::module-03-backup-restore/21a.png[]

. *_Dashboard_* に戻って進捗を確認します。

. 完了後、*_OpenShift Console → Virtualization → Virtual Machines_* に戻り `fedora-k10` が *_Running_* であることを確認します。
+
image::module-03-backup-restore/22.png[]
+
====
[NOTE]
以下で DataSource が `k10-csi-snap-...` になっていることを確認できます。
[source,bash,role=execute,subs="attributes"]
----
oc describe pvc fedora-k10 -n kasten-lab-{user}
----
====

== 8. リモートリストアの実行

ローカルスナップショットが利用できない場合はリモートリポジトリから復元します。

. *_Web Terminal_* で以下を実行し、namespace を削除します。
+
[source,bash,role=execute,subs="attributes"]
----
oc delete virtualmachine fedora-k10 -n kasten-lab-{user}
oc delete project kasten-lab-{user}
----
+
====
[IMPORTANT]
_"スナップショットはバックアップではない"_ — Mark Twain  

VolumeSnapshot は namespace に属するため、namespace 削除時に消えます。
Ceph の `deletionPolicy: Delete` 設定によりスナップショット自体も削除されます。
====

. *_Kasten Dashboard_* → *_Applications_* に戻り、`kasten-lab-{user}` が消えていることを確認します。

. *_All_* ドロップダウンから *_Removed_* を選びます。
+
image::module-03-backup-restore/23.png[]

. `kasten-lab-{user}` の右で *_... → Restore_* を選択します。
. 最新の RestorePoint の *_EXPORTED_* 版を選択します。
+
image::module-03-backup-restore/24.png[]

. *_Application Name_* の欄で *_+ Create New Namespace_* をクリックし、`kasten-lab-clone-{user}` を入力して *_Create_* をクリックします。
+
image::module-03-backup-restore/25.png[]
+
====
[WARNING]
必ず緑の *_Create_* ボタンをクリックしてください。
====

. *_Restore_* をクリックし、確認画面でも再度 *_Restore_* をクリックします。
+
image::module-03-backup-restore/25a.png[]

. *_Dashboard_* で進捗を確認します。
+
image::module-03-backup-restore/26.png[]

. *_OpenShift Console → Virtualization → VirtualMachines_* で、`kasten-lab-clone-{user}` namespace に `fedora-k10` VM が稼働していることを確認します。
+
image::module-03-backup-restore/27.png[]
+
====
[NOTE]
ローカルリストアと異なり、PVC に DataSource のスナップショット参照はありません。
[source,bash,role=execute,subs="attributes"]
----
oc describe pvc fedora-k10 -n kasten-lab-clone-{user}
----
====

== 9. まとめ

_おめでとうございます！ Veeam Kasten を使用して初めてのワークロードの保護と復元を行いました！_  
このラボで学んだ主なポイントは以下の通りです。

* Kasten はクラスタ上で動作し、OperatorHub または Helm チャートでデプロイ可能
* 認証は Token、OIDC、LDAP、OpenShift OAuth に対応し、Kubernetes RBAC により名前空間単位のセルフサービスも可能
* バックアップ先として S3、Azure Blob、Google Cloud Storage、NFS、Veeam Backup & Replication をサポート
* イミュータブルバックアップでランサムウェアから保護
* Ceph RBD の `Block` モードは Live Migration に最適
* Kasten は常に増分バックアップを行い、`Filesystem` と `Block` の両方に対応
